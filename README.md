# ğŸ¤– K8s AIOps Copilot

åŸºäº [HolmesGPT](https://github.com/robusta-dev/holmesgpt) çš„æ™ºèƒ½è¿ç»´ Copilotï¼Œä¸“æ³¨äº Kubernetes é›†ç¾¤æ•…éšœè¯Šæ–­ä¸è‡ªåŠ¨ä¿®å¤ã€‚

**å½“å‰ç‰ˆæœ¬**: `2.3.2`

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- ğŸ” **æ™ºèƒ½è¯Šæ–­**: åŸºäº DSPy çš„é—®é¢˜åˆ†ç±»ï¼Œè‡ªåŠ¨åŒ¹é…è¯Šæ–­ç­–ç•¥
- ğŸ› ï¸ **è‡ªåŠ¨ä¿®å¤**: è¯†åˆ«æ ¹å› åè‡ªåŠ¨æ‰§è¡Œå®‰å…¨çš„ä¿®å¤æ“ä½œ
- ğŸ“š **Runbook çŸ¥è¯†åº“**: å†…ç½®å¸¸è§æ•…éšœä¿®å¤æ‰‹å†Œ
- ğŸ”Œ **MCP æ‰©å±•**: æ”¯æŒå¤–éƒ¨å·¥å…·é›†æˆï¼ˆHelmã€Prometheusã€Elasticsearch ç­‰ï¼‰
- ğŸ“Š **æµå¼è¾“å‡º**: å®æ—¶æŸ¥çœ‹è¯Šæ–­è¿‡ç¨‹

---

## ğŸš€ å¿«é€Ÿä½¿ç”¨

### éƒ¨ç½²åè°ƒç”¨ API

```bash
# ğŸ”¥ æœ€ç®€å•çš„æ–¹å¼ï¼ˆæ¨èï¼‰
curl -X POST "http://<NODE_IP>:30800/ask" -d "q=Pod ä¸€ç›´åœ¨é‡å¯"

# ä¸­æ–‡é—®é¢˜ï¼ˆGET æ–¹å¼éœ€è¦ URL ç¼–ç ï¼‰
curl -G "http://<NODE_IP>:30800/ask" --data-urlencode "q=ç£ç›˜æ»¡äº†æ€ä¹ˆæ¸…ç†"

# æµå¼è¾“å‡ºï¼ˆé»˜è®¤å¼€å¯ï¼‰
curl -N -X POST "http://<NODE_IP>:30800/ask" -d "q=æ£€æŸ¥é›†ç¾¤å¥åº·çŠ¶æ€"

# è°ƒæ•´æœ€å¤§æ­¥æ•°ï¼ˆå¤æ‚é—®é¢˜ï¼‰
curl -X POST "http://<NODE_IP>:30800/ask" -d "q=å®‰è£… observability" -d "max_steps=50"
```

### å¯ç”¨ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/ask` | GET/POST | ä¸»è¦æŸ¥è¯¢å…¥å£ |
| `/q/{é—®é¢˜}` | GET | è·¯å¾„å‚æ•°æ–¹å¼ |
| `/health` | GET | å¥åº·æ£€æŸ¥ |
| `/tools` | GET | å¯ç”¨å·¥å…·åˆ—è¡¨ |
| `/runbooks` | GET | å¯ç”¨ Runbooks |
| `/api/v1/mcp/status` | GET | MCP æœåŠ¡å™¨çŠ¶æ€ |

### API å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `q` | string | å¿…å¡« | é—®é¢˜å†…å®¹ |
| `stream` | bool | true | æ˜¯å¦æµå¼è¾“å‡º |
| `format` | string | text | è¾“å‡ºæ ¼å¼: text/sse |
| `max_steps` | int | 20 | æœ€å¤§æ‰§è¡Œæ­¥æ•° (1-100) |

---

## â˜¸ï¸ K8s éƒ¨ç½²

### ä¸€é”®éƒ¨ç½²

```bash
# 1. é…ç½® API Keyï¼ˆå¿…é¡»ï¼‰
vim deploy/secrets/core.yaml    # å¡«å…¥ DEEPSEEK_API_KEY

# 2. æ„å»ºã€æ¨é€ã€éƒ¨ç½²
make build push deploy

# 3. æŸ¥çœ‹æ—¥å¿—
make logs
```

### éƒ¨ç½²æ–‡ä»¶è¯´æ˜

```
deploy/
â”œâ”€â”€ k8s-simple.yaml           # Deployment + Service (NodePort: 30800)
â”œâ”€â”€ rbac.yaml                 # ServiceAccount + ClusterRole
â”œâ”€â”€ configmap/
â”‚   â”œâ”€â”€ config.yaml           # åº”ç”¨é…ç½®ï¼ˆå·¥å…·é›†/MCPï¼‰
â”‚   â””â”€â”€ runbooks.yaml         # Runbook çŸ¥è¯†åº“
â””â”€â”€ secrets/
    â””â”€â”€ core.yaml             # API Key ç­‰æ•æ„Ÿä¿¡æ¯
```

### Makefile å‘½ä»¤

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `make build` | æ„å»º Docker é•œåƒ |
| `make push` | æ¨é€åˆ°é•œåƒä»“åº“ |
| `make deploy` | éƒ¨ç½²åˆ° K8sï¼ˆè‡ªåŠ¨åŒæ­¥ç‰ˆæœ¬ï¼‰ |
| `make delete` | åˆ é™¤éƒ¨ç½²ï¼ˆä¿ç•™ namespaceï¼‰ |
| `make restart` | é‡å¯ Podï¼ˆåˆ·æ–° ConfigMapï¼‰ |
| `make logs` | æŸ¥çœ‹å®æ—¶æ—¥å¿— |

---

## ğŸ“š Runbook çŸ¥è¯†åº“

å†…ç½®æ•…éšœä¿®å¤æ‰‹å†Œï¼ŒAI ä¼šè‡ªåŠ¨å‚è€ƒï¼š

| Runbook | è¯´æ˜ |
|---------|------|
| `disk-full` | ç£ç›˜ç©ºé—´è€—å°½è¯Šæ–­ä¸ä¿®å¤ |
| `crashloop-backoff` | Pod å´©æºƒå¾ªç¯ï¼ˆCrashLoopBackOffï¼‰åˆ†æ |
| `port-conflict` | ç«¯å£å†²çªè¯Šæ–­ä¸ä¿®å¤ |
| `prometheus-metrics` | Prometheus æŒ‡æ ‡æŸ¥è¯¢æŒ‡å— |
| `helm-observability-install` | Helm å®‰è£…å¯è§‚æµ‹æ€§å¹³å° |

### æ›´æ–° Runbook

```bash
# ç¼–è¾‘ ConfigMap
kubectl edit configmap aiops-runbooks -n aiops

# æˆ–ä¿®æ”¹æ–‡ä»¶åé‡æ–°éƒ¨ç½²
vim deploy/configmap/runbooks.yaml
make restart
```

---

## ğŸ§  DSPy é—®é¢˜åˆ†ç±»

ç³»ç»Ÿä½¿ç”¨ DSPy è‡ªåŠ¨åˆ†ç±»ç”¨æˆ·é—®é¢˜ï¼ŒåŒ¹é…æœ€ä½³è¯Šæ–­ç­–ç•¥ï¼š

| é—®é¢˜ç±»å‹ | è§¦å‘å…³é”®è¯ | è¯Šæ–­ç­–ç•¥ |
|----------|-----------|----------|
| `disk_full` | ç£ç›˜æ»¡ã€No space left | æ£€æŸ¥ dfã€å®šä½å¤§æ–‡ä»¶ |
| `pod_crash` | CrashLoopBackOffã€é‡å¯ | æ£€æŸ¥ logsã€Exit Code |
| `port_conflict` | ç«¯å£å ç”¨ã€Address in use | æ£€æŸ¥ netstatã€lsof |
| `helm_install` | å®‰è£… helmã€éƒ¨ç½²ç›‘æ§ | ä½¿ç”¨ MCP Helm å·¥å…· |
| `oom_killed` | OOMã€å†…å­˜æº¢å‡º | æ£€æŸ¥ limitsã€Prometheus |

---

## ğŸ”Œ MCP å·¥å…·é›†

### å†…ç½®å·¥å…·

| å·¥å…·é›† | è¯´æ˜ |
|--------|------|
| `kubernetes/core` | kubectl å‘½ä»¤å°è£… |
| `prometheus/metrics` | Prometheus æŸ¥è¯¢ |
| `bash` | å®‰å…¨çš„ bash å‘½ä»¤ |

### å¤–éƒ¨ MCP æœåŠ¡å™¨

é€šè¿‡ `config.yaml` é…ç½®å¤–éƒ¨ MCP æœåŠ¡å™¨ï¼š

```yaml
mcp_servers:
  elasticsearch:
    config:
      url: "http://mcp-server:8082/sse"
      mode: "sse"
    enabled: true
  
  helmcharts:
    config:
      url: "http://mcp-helm:8083/sse"
      mode: "sse"
    enabled: true
```

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/routes.py           # FastAPI è·¯ç”±
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ service.py          # æ ¸å¿ƒæœåŠ¡ï¼ˆâ­é‡ç‚¹ï¼‰
â”‚   â”‚   â”œâ”€â”€ prompts.py          # System Prompt + FOCUSED_PROMPTS
â”‚   â”‚   â”œâ”€â”€ dspy_enhancer.py    # DSPy é—®é¢˜åˆ†ç±»å™¨
â”‚   â”‚   â”œâ”€â”€ mcp_manager.py      # MCP æœåŠ¡å™¨ç®¡ç†
â”‚   â”‚   â””â”€â”€ runbook.py          # Runbook åŠ è½½
â”‚   â””â”€â”€ main.py                 # åº”ç”¨å…¥å£
â”œâ”€â”€ deploy/                     # K8s éƒ¨ç½²æ–‡ä»¶
â”œâ”€â”€ config/config.yaml          # æœ¬åœ°å¼€å‘é…ç½®
â”œâ”€â”€ Dockerfile                  # å®¹å™¨é•œåƒ
â”œâ”€â”€ Makefile                    # æ„å»º/éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ VERSION                     # ç‰ˆæœ¬å·
â””â”€â”€ requirements.txt            # Python ä¾èµ–
```

---

## ğŸ”§ æœ¬åœ°å¼€å‘

```bash
# 1. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv .venv && source .venv/bin/activate

# 2. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 3. é…ç½®ç¯å¢ƒå˜é‡
export DEEPSEEK_API_KEY="your-api-key"
export CONFIG_FILE="config/config.yaml"

# 4. å¯åŠ¨æœåŠ¡
python run.py

# 5. æµ‹è¯•
curl -X POST "http://localhost:8000/ask" -d "q=æ£€æŸ¥é›†ç¾¤çŠ¶æ€"
```

---

## ğŸ” å®‰å…¨é…ç½®

### æ•æ„Ÿä¿¡æ¯ä½ç½®

| æ–‡ä»¶ | å†…å®¹ | è¯´æ˜ |
|------|------|------|
| `deploy/secrets/core.yaml` | DEEPSEEK_API_KEY | LLM API å¯†é’¥ |
| `deploy/secrets/core.yaml` | BASH_TOOL_UNSAFE_ALLOW_ALL | å…è®¸æ‰§è¡Œæ‰€æœ‰ bash å‘½ä»¤ |
| `deploy/configmap/runbooks.yaml` | Helm Repo å‡­è¯ | observability ç§æœ‰ä»“åº“ |

### å®‰å…¨å»ºè®®

- âš ï¸ ä¸è¦å°†çœŸå®å¯†é’¥æäº¤åˆ° Git
- ä½¿ç”¨ `.gitignore` å¿½ç•¥ `deploy/secrets/*.yaml`
- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Kubernetes Secrets æˆ–å¤–éƒ¨å¯†é’¥ç®¡ç†

---

## ğŸ“Š æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç”¨æˆ·è¯·æ±‚                               â”‚
â”‚              curl /ask?q="Pod ä¸€ç›´é‡å¯"                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DSPy é—®é¢˜åˆ†ç±»å™¨                           â”‚
â”‚         problem_type: "pod_crash" â†’ FOCUSED_PROMPT          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      HolmesGPT å¼•æ“                          â”‚
â”‚     SYSTEM_PROMPT + FOCUSED_PROMPT + Runbooks + Tools       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼               â–¼               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ kubectl  â”‚   â”‚Prometheusâ”‚   â”‚ MCP å·¥å…· â”‚
        â”‚  å·¥å…·    â”‚   â”‚  æŸ¥è¯¢    â”‚   â”‚(Helmç­‰)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¤ è‡´è°¢

- [HolmesGPT](https://github.com/robusta-dev/holmesgpt) - AI æ•…éšœè¯Šæ–­å¼•æ“
- [DSPy](https://github.com/stanfordnlp/dspy) - å£°æ˜å¼ LLM ç¼–ç¨‹æ¡†æ¶
- [DeepSeek](https://www.deepseek.com/) - LLM æä¾›å•†

# Runbook çŸ¥è¯†åº“ ConfigMap
# å®šä½ï¼šè¿ç»´é¢†åŸŸçŸ¥è¯†åº“ + ä¿®å¤æ‰‹å†Œ
# æ ¸å¿ƒ 3 Caseï¼šç£ç›˜æ»¡ã€å®¹å™¨å´©æºƒã€ç«¯å£å†²çª

apiVersion: v1
kind: ConfigMap
metadata:
  name: aiops-runbooks
  namespace: aiops
data:
  catalog.json: |
    {
      "catalog": [
        {
          "id": "disk-full",
          "update_date": "2025-12-12",
          "description": "Linux ç£ç›˜ç©ºé—´è€—å°½çš„åŸç†åˆ†æã€å¸¸è§åœºæ™¯ã€è¯Šæ–­æ–¹æ³•å’Œä¿®å¤ç­–ç•¥",
          "link": "disk-full.md"
        },
        {
          "id": "crashloop-backoff",
          "update_date": "2025-12-12",
          "description": "Kubernetes å®¹å™¨å´©æºƒå¾ªç¯çš„åŸç†åˆ†æã€Exit Code è§£è¯»ã€å¸¸è§åœºæ™¯å’Œä¿®å¤ç­–ç•¥",
          "link": "crashloop-backoff.md"
        },
        {
          "id": "port-conflict",
          "update_date": "2025-12-12",
          "description": "TCP ç«¯å£å†²çªçš„åŸç†åˆ†æã€å¸¸è§åœºæ™¯ã€è¯Šæ–­æ–¹æ³•å’Œä¿®å¤ç­–ç•¥",
          "link": "port-conflict.md"
        },
        {
          "id": "helm-observability-install",
          "update_date": "2025-12-16",
          "description": "ä½¿ç”¨ Helm ä»ç§æœ‰ GitLab Package Registry å®‰è£… Observability å¯è§‚æµ‹æ€§å¹³å°ï¼ˆåŒ…å« Prometheusã€Grafanaã€DeepFlowã€ELK ç­‰ç»„ä»¶ï¼‰ï¼Œæ”¯æŒè‡ªå®šä¹‰é…ç½®å’Œç‰ˆæœ¬ç®¡ç†",
          "link": "helm-observability-install.md"
        }
      ]
    }

  # ==========================================================================
  # ç£ç›˜ç©ºé—´è€—å°½æ•…éšœæ‰‹å†Œ
  # ==========================================================================
  disk-full.md: |
    # ç£ç›˜ç©ºé—´è€—å°½æ•…éšœæ‰‹å†Œ

    ## æ•…éšœç‰¹å¾
    **é”™è¯¯å…³é”®è¯**: `No space left on device`ã€`ENOSPC`ã€`disk full`
    
    **å…¸å‹è¡¨ç°**:
    - æ—¥å¿—æ— æ³•å†™å…¥ï¼ŒæœåŠ¡æŠ¥é”™
    - Docker é•œåƒæ‹‰å–å¤±è´¥
    - æ•°æ®åº“å†™å…¥å¤±è´¥
    - Pod å¯åŠ¨å¤±è´¥ï¼ˆé•œåƒå±‚æ— æ³•è§£å‹ï¼‰

    ## é—®é¢˜åŸç†
    Linux æ–‡ä»¶ç³»ç»Ÿç©ºé—´è€—å°½æ—¶ï¼Œæ‰€æœ‰å†™æ“ä½œè¿”å› ENOSPC é”™è¯¯ã€‚
    å¸¸è¢«å¿½è§†çš„æ˜¯ **inode è€—å°½**ï¼ˆå¤§é‡å°æ–‡ä»¶ï¼‰ä¹Ÿä¼šå¯¼è‡´ç›¸åŒé”™è¯¯ã€‚

    ## å¸¸è§åœºæ™¯ä¸æ ¹å› 

    ### åœºæ™¯ 1: æ—¥å¿—è†¨èƒ€ï¼ˆæœ€å¸¸è§ï¼Œå  60%ï¼‰
    **ç‰¹å¾**: `/var/log` ç›®å½•å ç”¨å¼‚å¸¸
    **æ ¹å› **: 
    - åº”ç”¨æ—¥å¿—æœªé…ç½®è½®è½¬ï¼ˆlogrotateï¼‰
    - æ—¥å¿—çº§åˆ«è®¾ç½®ä¸º DEBUG äº§ç”Ÿå¤§é‡æ—¥å¿—
    - é”™è¯¯å¾ªç¯å¯¼è‡´æ—¥å¿—çˆ†ç‚¸å¼å¢é•¿
    **ä¿®å¤**: é…ç½® logrotateï¼Œæˆªæ–­å¤§æ—¥å¿—æ–‡ä»¶

    ### åœºæ™¯ 2: Docker/å®¹å™¨æ•°æ®å †ç§¯ï¼ˆå  25%ï¼‰
    **ç‰¹å¾**: `/var/lib/docker` æˆ– `/var/lib/containerd` å ç”¨å¼‚å¸¸
    **æ ¹å› **:
    - æœªæ¸…ç†çš„æ—§é•œåƒå±‚
    - å·²åœæ­¢å®¹å™¨çš„æ•°æ®æœªæ¸…ç†
    - å®¹å™¨å†…æ—¥å¿—æœªé™åˆ¶å¤§å°
    **ä¿®å¤**: `docker system prune -af` æ¸…ç†æœªä½¿ç”¨èµ„æº

    ### åœºæ™¯ 3: åº”ç”¨æ•°æ®å¢é•¿ï¼ˆå  10%ï¼‰
    **ç‰¹å¾**: `/data`ã€`/home` æˆ–åº”ç”¨è‡ªå®šä¹‰ç›®å½•å ç”¨å¤§
    **æ ¹å› **: ä¸šåŠ¡æ•°æ®è‡ªç„¶å¢é•¿ï¼ŒæœªåŠæ—¶å½’æ¡£
    **ä¿®å¤**: å½’æ¡£å†å²æ•°æ®ï¼Œæ‰©å®¹ç£ç›˜

    ### åœºæ™¯ 4: ä¸´æ—¶æ–‡ä»¶æœªæ¸…ç†ï¼ˆå  5%ï¼‰
    **ç‰¹å¾**: `/tmp` ç›®å½•å ç”¨å¼‚å¸¸
    **æ ¹å› **: åº”ç”¨äº§ç”Ÿä¸´æ—¶æ–‡ä»¶æœªæ¸…ç†
    **ä¿®å¤**: æ¸…ç†è¿‡æœŸä¸´æ—¶æ–‡ä»¶

    ### åœºæ™¯ 5: K8s ephemeral-storage è¶…é™ï¼ˆå®¹å™¨åœºæ™¯ï¼‰
    **é”™è¯¯å…³é”®è¯**: `ephemeral local storage usage exceeds`ã€`Evicted`ã€`Pod was evicted`
    **ç‰¹å¾**: 
    - Pod çŠ¶æ€ä¸º `Evicted`
    - Events æ˜¾ç¤º `The node was low on resource: ephemeral-storage`
    - å®¹å™¨å†… dd/å†™å…¥æ“ä½œæŠ¥é”™ `No space left on device`
    **æ ¹å› **:
    - å®¹å™¨å†™å…¥æ•°æ®è¶…è¿‡ `limits.ephemeral-storage` é™åˆ¶
    - åº”ç”¨åœ¨å®¹å™¨å†…ç”Ÿæˆå¤§æ–‡ä»¶ï¼ˆæ—¥å¿—ã€ä¸´æ—¶æ–‡ä»¶ã€ç¼“å­˜ï¼‰
    - æœªé…ç½® ephemeral-storage é™åˆ¶ï¼Œè¢«èŠ‚ç‚¹é©±é€
    **ä¿®å¤**: 
    - å¢åŠ  ephemeral-storage é™åˆ¶
    - æ¸…ç†å®¹å™¨å†…å¤§æ–‡ä»¶
    - ä½¿ç”¨ PVC å­˜å‚¨å¤§æ–‡ä»¶

    ## è¯Šæ–­æ–¹æ³•è®º

    ### é€šç”¨è¯Šæ–­æµç¨‹
    1. `df -h` ç¡®è®¤å“ªä¸ªæŒ‚è½½ç‚¹æ»¡äº†
    2. `du -sh /*` å®šä½ä¸€çº§ç›®å½•
    3. æ ¹æ®å¤§ç›®å½•ç‰¹å¾åŒ¹é…ä¸Šè¿°åœºæ™¯
    4. é’ˆå¯¹æ€§å¤„ç†

    ### å¿«é€Ÿå®šä½å‘½ä»¤
    ```bash
    # ç‰©ç†æœºç£ç›˜ä½¿ç”¨ç‡
    df -h
    
    # ä¸€çº§ç›®å½•å¤§å°æ’åº
    du -sh /* 2>/dev/null | sort -hr | head -5
    
    # Docker ç©ºé—´ä½¿ç”¨
    docker system df
    ```

    ### K8s ephemeral-storage è¯Šæ–­
    ```bash
    # æŸ¥æ‰¾è¢«é©±é€çš„ Pod
    kubectl get pod -A | grep Evicted
    
    # æŸ¥çœ‹ Pod äº‹ä»¶ï¼ˆæ‰¾ ephemeral-storage ç›¸å…³ï¼‰
    kubectl describe pod <pod-name> -n <namespace>
    
    # æŸ¥çœ‹ Pod çš„ ephemeral-storage é…ç½®
    kubectl get pod <pod-name> -n <namespace> -o jsonpath='{.spec.containers[*].resources}'
    ```

    ## ğŸ”§ ä¿®å¤å‘½ä»¤ï¼ˆç›´æ¥æ‰§è¡Œï¼‰
    **ç¦æ­¢åˆ é™¤é‡è¦æ–‡ä»¶ï¼åªèƒ½æ¸…ç†æ— å…³ç´§è¦çš„æ•°æ®ã€‚**

    ### ç‰©ç†æœºç£ç›˜æ¸…ç†
    ```bash
    # æ¸…ç† Docker æœªä½¿ç”¨èµ„æºï¼ˆå®‰å…¨ï¼‰
    docker system prune -af
    
    # æˆªæ–­å¤§æ—¥å¿—æ–‡ä»¶ï¼ˆå®‰å…¨ï¼Œä¸åˆ é™¤ï¼‰
    truncate -s 0 /path/to/large.log
    ```

    ### K8s ephemeral-storage è¶…é™ä¿®å¤
    ```bash
    # æ–¹æ¡ˆ1ï¼šå¢åŠ  ephemeral-storage é™åˆ¶ï¼ˆæ¨èï¼‰
    kubectl patch deployment <deployment-name> -n <namespace> -p '{"spec":{"template":{"spec":{"containers":[{"name":"<container-name>","resources":{"limits":{"ephemeral-storage":"500Mi"}}}]}}}}'
    
    # æ–¹æ¡ˆ2ï¼šåˆ é™¤è¢«é©±é€çš„ Podï¼ˆè®©å…¶é‡å»ºï¼‰
    kubectl delete pod <pod-name> -n <namespace>
    
    # æ–¹æ¡ˆ3ï¼šæ¸…ç†æ‰€æœ‰ Evicted Pod
    kubectl get pod -A | grep Evicted | awk '{print $2 " -n " $1}' | xargs -L1 kubectl delete pod
    ```

    ## ğŸ” ä¿®å¤åéªŒè¯
    ```bash
    # éªŒè¯ç£ç›˜ç©ºé—´
    df -h
    
    # éªŒè¯ Pod çŠ¶æ€
    kubectl get pod -n <namespace>
    ```

    ### ä¸å»ºè®®æ“ä½œ
    - åˆ é™¤ç³»ç»Ÿæ—¥å¿—ï¼ˆ/var/log/messagesã€syslogï¼‰
    - åˆ é™¤æœªçŸ¥å¤§æ–‡ä»¶

    ## é¢„é˜²æªæ–½
    - é…ç½®æ—¥å¿—è½®è½¬ï¼ˆlogrotateï¼‰
    - è®¾ç½®ç£ç›˜ä½¿ç”¨ç‡ç›‘æ§å‘Šè­¦ï¼ˆé˜ˆå€¼ 80%ï¼‰
    - å®šæœŸæ‰§è¡Œ Docker æ¸…ç†ä»»åŠ¡
    - å®¹å™¨æ—¥å¿—é…ç½®å¤§å°é™åˆ¶

  # ==========================================================================
  # CrashLoopBackOff æ•…éšœæ‰‹å†Œ
  # ==========================================================================
  crashloop-backoff.md: |
    # CrashLoopBackOff æ•…éšœæ‰‹å†Œ

    ## æ•…éšœç‰¹å¾
    **çŠ¶æ€å…³é”®è¯**: `CrashLoopBackOff`ã€`Error`ã€`Restart Count > 0`
    
    **å…¸å‹è¡¨ç°**:
    - Pod çŠ¶æ€åå¤åœ¨ Running å’Œ CrashLoopBackOff ä¹‹é—´åˆ‡æ¢
    - Restart Count æŒç»­å¢åŠ 
    - æœåŠ¡æ— æ³•æ­£å¸¸æä¾›

    ## é—®é¢˜åŸç†
    Kubernetes æ£€æµ‹åˆ°å®¹å™¨é€€å‡ºåä¼šå°è¯•é‡å¯ï¼Œä½†å¦‚æœå®¹å™¨æŒç»­é€€å‡ºï¼Œ
    kubelet ä¼šé€æ¸å¢åŠ é‡å¯é—´éš”ï¼ˆæŒ‡æ•°é€€é¿ï¼‰ï¼Œæœ€ç»ˆè¿›å…¥ CrashLoopBackOff çŠ¶æ€ã€‚

    **é€€é¿æ—¶é—´**: 10s â†’ 20s â†’ 40s â†’ 80s â†’ ... â†’ æœ€å¤§ 5 åˆ†é’Ÿ

    ## Exit Code çŸ¥è¯†åº“

    | Exit Code | ä¿¡å· | å«ä¹‰ | å…¸å‹åœºæ™¯ |
    |-----------|------|------|---------|
    | 0 | - | æ­£å¸¸é€€å‡º | ä¸€æ¬¡æ€§ä»»åŠ¡å®Œæˆã€å¯åŠ¨å‘½ä»¤é”™è¯¯ |
    | 1 | - | åº”ç”¨é”™è¯¯ | é…ç½®é”™è¯¯ã€ä¾èµ–ç¼ºå¤±ã€ä»£ç å¼‚å¸¸ |
    | 126 | - | æ— æ‰§è¡Œæƒé™ | è„šæœ¬æ²¡æœ‰æ‰§è¡Œæƒé™ |
    | 127 | - | å‘½ä»¤ä¸å­˜åœ¨ | command é…ç½®é”™è¯¯ã€é•œåƒç¼ºå°‘ä¾èµ– |
    | 137 | SIGKILL(9) | OOMKilled | å†…å­˜è¶…é™è¢«ç³»ç»Ÿæ€æ­» |
    | 139 | SIGSEGV(11) | æ®µé”™è¯¯ | åº”ç”¨è®¿é—®éæ³•å†…å­˜ |
    | 143 | SIGTERM(15) | ä¼˜é›…ç»ˆæ­¢ | è¢« K8s ä¸»åŠ¨ç»ˆæ­¢ã€å¥åº·æ£€æŸ¥å¤±è´¥ |

    ## å¸¸è§åœºæ™¯ä¸æ ¹å› 

    ### åœºæ™¯ 1: OOMKilledï¼ˆExit Code 137ï¼‰
    **ç‰¹å¾**: Last State Reason ä¸º `OOMKilled`
    **æ ¹å› **: 
    - memory limit è®¾ç½®è¿‡ä½
    - åº”ç”¨å†…å­˜æ³„æ¼
    - JVM/Node.js å †å†…å­˜é…ç½®ä¸å½“
    **ä¿®å¤**: å¢åŠ  memory limitï¼Œæˆ–ä¼˜åŒ–åº”ç”¨å†…å­˜ä½¿ç”¨

    ### åœºæ™¯ 2: åº”ç”¨é…ç½®é”™è¯¯ï¼ˆExit Code 1ï¼‰
    **ç‰¹å¾**: æ—¥å¿—ä¸­æœ‰æ˜ç¡®çš„é…ç½®ç›¸å…³é”™è¯¯
    **æ ¹å› **:
    - ç¯å¢ƒå˜é‡ç¼ºå¤±æˆ–é”™è¯¯
    - ConfigMap/Secret é…ç½®é”™è¯¯
    - æ•°æ®åº“è¿æ¥ä¸²é”™è¯¯
    **ä¿®å¤**: ä¿®æ­£é…ç½®åé‡å¯ Pod

    ### åœºæ™¯ 3: ä¾èµ–æœåŠ¡ä¸å¯ç”¨ï¼ˆExit Code 1ï¼‰
    **ç‰¹å¾**: æ—¥å¿—ä¸­æœ‰ `connection refused`ã€`timeout` ç­‰
    **æ ¹å› **: 
    - ä¾èµ–çš„æ•°æ®åº“ã€ç¼“å­˜ã€API ä¸å¯ç”¨
    - DNS è§£æå¤±è´¥
    - ç½‘ç»œç­–ç•¥é˜»æ­¢è®¿é—®
    **ä¿®å¤**: ç¡®ä¿ä¾èµ–æœåŠ¡å¯ç”¨ï¼Œæ£€æŸ¥ç½‘ç»œç­–ç•¥

    ### åœºæ™¯ 4: å¯åŠ¨å‘½ä»¤é”™è¯¯ï¼ˆExit Code 0/127ï¼‰
    **ç‰¹å¾**: Pod å¯åŠ¨åç«‹å³é€€å‡ºï¼Œå‡ ä¹æ²¡æœ‰æ—¥å¿—
    **æ ¹å› **:
    - command/args é…ç½®é”™è¯¯
    - å…¥å£ç‚¹è„šæœ¬æœ‰é—®é¢˜
    **ä¿®å¤**: æ£€æŸ¥å¹¶ä¿®æ­£ command é…ç½®

    ### åœºæ™¯ 5: å¥åº·æ£€æŸ¥è¿‡ä¸¥ï¼ˆExit Code 143ï¼‰
    **ç‰¹å¾**: åº”ç”¨æ—¥å¿—æ­£å¸¸ï¼Œä½†è¢«é¢‘ç¹é‡å¯
    **æ ¹å› **:
    - livenessProbe è¶…æ—¶æ—¶é—´å¤ªçŸ­
    - å¥åº·æ£€æŸ¥ç«¯ç‚¹å“åº”æ…¢
    - initialDelaySeconds ä¸è¶³
    **ä¿®å¤**: æ”¾å®½å¥åº·æ£€æŸ¥é…ç½®

    ## è¯Šæ–­æ–¹æ³•è®º

    ### é€šç”¨è¯Šæ–­æµç¨‹
    1. `kubectl describe pod` è·å– Exit Code å’Œ Reason
    2. `kubectl logs --previous` è·å–å´©æºƒå‰æ—¥å¿—
    3. æ ¹æ® Exit Code å’Œæ—¥å¿—åŒ¹é…ä¸Šè¿°åœºæ™¯
    4. é’ˆå¯¹æ€§ä¿®å¤

    ### å…³é”®è¯Šæ–­å‘½ä»¤
    ```bash
    # è·å– Pod çŠ¶æ€å’Œ Exit Code
    kubectl describe pod <name> -n <ns>
    
    # è·å–ä¸Šä¸€æ¬¡å´©æºƒçš„æ—¥å¿—
    kubectl logs <name> -n <ns> --previous
    ```

    ## ğŸ”§ ä¿®å¤å‘½ä»¤ï¼ˆç›´æ¥æ‰§è¡Œï¼‰
    æ ¹æ®é—®é¢˜ç›´æ¥è¿›è¡Œä½ è®¤ä¸ºå¯è¡Œçš„ä¿®æ”¹ï¼Œç›´æ¥æ‰§è¡Œå‘½ä»¤å¸®æˆ‘ä¿®å¤å¹¶ä¸”è§£å†³é—®é¢˜ã€‚
    ### é€šç”¨ä¿®å¤ï¼šåˆ é™¤ Pod è®©å…¶é‡å»º
    ```bash
    kubectl delete pod <pod-name> -n <namespace>
    ```

    ### OOMKilled (Exit Code 137) ä¿®å¤
    ```bash
    # å¢åŠ å†…å­˜é™åˆ¶åˆ° 1Gi
    kubectl patch deployment <deployment-name> -n <namespace> -p '{"spec":{"template":{"spec":{"containers":[{"name":"<container-name>","resources":{"limits":{"memory":"1Gi"}}}]}}}}'
    ```

    ### å¯åŠ¨å‘½ä»¤é”™è¯¯ (Exit Code 1/127) ä¿®å¤
    ```bash
    # ä¿®å¤å¯åŠ¨å‘½ä»¤ï¼ˆç¤ºä¾‹ï¼šæ”¹ä¸ºæ­£å¸¸è¿è¡Œçš„å‘½ä»¤ï¼‰
    kubectl patch deployment <deployment-name> -n <namespace> -p '{"spec":{"template":{"spec":{"containers":[{"name":"<container-name>","command":["/bin/sh","-c","sleep infinity"]}]}}}}'
    ```

    ### é…ç½®é”™è¯¯ä¿®å¤
    ```bash
    # é‡å¯ Deployment ä½¿é…ç½®ç”Ÿæ•ˆ
    kubectl rollout restart deployment <deployment-name> -n <namespace>
    ```

    ### å¥åº·æ£€æŸ¥è¿‡ä¸¥ä¿®å¤
    ```bash
    # æ”¾å®½ livenessProbeï¼ˆå¢åŠ è¶…æ—¶å’Œå¤±è´¥é˜ˆå€¼ï¼‰
    kubectl patch deployment <deployment-name> -n <namespace> -p '{"spec":{"template":{"spec":{"containers":[{"name":"<container-name>","livenessProbe":{"initialDelaySeconds":60,"timeoutSeconds":10,"failureThreshold":5}}]}}}}'
    ```

    ### åˆ é™¤æœ‰é—®é¢˜çš„ Deploymentï¼ˆæœ€åæ‰‹æ®µï¼‰
    ```bash
    kubectl delete deployment <deployment-name> -n <namespace>
    ```

    ## ğŸ” ä¿®å¤åéªŒè¯
    ```bash
    # æ£€æŸ¥ Pod çŠ¶æ€æ˜¯å¦æ¢å¤æ­£å¸¸
    kubectl get pod -n <namespace> | grep <pod-name>
    # ç¡®è®¤ RESTARTS ä¸å†å¢åŠ ï¼ŒSTATUS ä¸º Running
    ```

    ## é¢„é˜²æªæ–½
    - è®¾ç½®åˆç†çš„èµ„æº requests/limitsï¼ˆlimits ä¸ºå®é™…ä½¿ç”¨çš„ 1.5-2 å€ï¼‰
    - ä½¿ç”¨ startupProbe å¤„ç†å¯åŠ¨æ…¢çš„åº”ç”¨
    - é…ç½® Pod é‡å¯å‘Šè­¦
    - åº”ç”¨å®ç°ä¼˜é›…å…³é—­

  # ==========================================================================
  # ç«¯å£å†²çªæ•…éšœæ‰‹å†Œ
  # ==========================================================================
  port-conflict.md: |
    # ç«¯å£å†²çªæ•…éšœæ‰‹å†Œ

    ## æ•…éšœç‰¹å¾
    **é”™è¯¯å…³é”®è¯**: `Address already in use`ã€`EADDRINUSE`ã€`bind failed`
    
    **å…¸å‹è¡¨ç°**:
    - æœåŠ¡å¯åŠ¨å¤±è´¥
    - æ—¥å¿—æ˜¾ç¤ºæ— æ³•ç»‘å®šç«¯å£
    - æ–°ç‰ˆæœ¬éƒ¨ç½²å¤±è´¥

    ## é—®é¢˜åŸç†
    TCP/UDP ç«¯å£æ˜¯**ç‰©ç†æœºçº§åˆ«**çš„ç³»ç»Ÿèµ„æºï¼ŒåŒä¸€ç«¯å£åŒä¸€æ—¶é—´åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ç›‘å¬ã€‚
    å½“æ–°è¿›ç¨‹å°è¯•ç»‘å®šå·²è¢«å ç”¨çš„ç«¯å£æ—¶ï¼Œç³»ç»Ÿè¿”å› EADDRINUSE é”™è¯¯ã€‚

    **ç‰¹æ®Šæƒ…å†µ**: 
    - TIME_WAIT çŠ¶æ€ï¼šè¿æ¥å…³é—­åç«¯å£å¯èƒ½ä¿æŒ 2MSLï¼ˆé€šå¸¸ 60sï¼‰
    - SO_REUSEADDRï¼šå…è®¸é‡ç”¨ TIME_WAIT çŠ¶æ€çš„ç«¯å£

    ## âš ï¸ K8s ç«¯å£æ¦‚å¿µæ¾„æ¸…ï¼ˆé‡è¦ï¼‰
    **ç«¯å£å†²çªåªå‘ç”Ÿåœ¨ç‰©ç†æœºå±‚é¢ï¼Œä¸è¦æ··æ·†ä»¥ä¸‹æ¦‚å¿µï¼š**

    | ç«¯å£ç±»å‹ | è¯´æ˜ | æ˜¯å¦ä¼šå†²çª |
    |---------|------|-----------|
    | **ç‰©ç†æœºç«¯å£** | ä¸»æœºä¸Šè¿›ç¨‹å®é™…ç›‘å¬çš„ç«¯å£ | âœ… ä¼šå†²çª |
    | hostPort | Pod ç›´æ¥æš´éœ²åˆ°ä¸»æœºçš„ç«¯å£ | âœ… ä¼šå†²çªï¼ˆåŒä¸€èŠ‚ç‚¹ï¼‰ |
    | NodePort | Service æš´éœ²åˆ°èŠ‚ç‚¹çš„ç«¯å£ï¼ˆ30000-32767ï¼‰ | âœ… ä¼šå†²çªï¼ˆåŒä¸€ NodePort å€¼ï¼‰ |
    | containerPort | å®¹å™¨å†…éƒ¨ç›‘å¬çš„ç«¯å£ | âŒ **ä¸ä¼šå†²çª**ï¼ˆPod ç½‘ç»œéš”ç¦»ï¼‰ |
    | Service port | Service çš„è™šæ‹Ÿç«¯å£ | âŒ **ä¸ä¼šå†²çª**ï¼ˆClusterIP ä¸åŒï¼‰ |

    **å¸¸è§è¯¯åˆ¤**ï¼š
    - âŒ å¤šä¸ª Deployment çš„ containerPort éƒ½æ˜¯ 8080 â†’ è¿™**ä¸æ˜¯**å†²çª
    - âŒ å¤šä¸ª Service çš„ targetPort éƒ½æ˜¯ 8080 â†’ è¿™**ä¸æ˜¯**å†²çª
    - âœ… ä¸¤ä¸ªè¿›ç¨‹éƒ½ bind åˆ°ä¸»æœºçš„ 0.0.0.0:8080 â†’ è¿™**æ˜¯**å†²çª
    - âœ… ä¸¤ä¸ª Pod éƒ½ç”¨ hostPort: 8080 è°ƒåº¦åˆ°åŒä¸€èŠ‚ç‚¹ â†’ è¿™**æ˜¯**å†²çª

    ## å¸¸è§åœºæ™¯ä¸æ ¹å› 

    ### åœºæ™¯ 1: æ—§ç‰ˆæœ¬è¿›ç¨‹æœªåœæ­¢ï¼ˆæœ€å¸¸è§ï¼Œå  70%ï¼‰
    **ç‰¹å¾**: åŒåè¿›ç¨‹å·²åœ¨è¿è¡Œ
    **æ ¹å› **:
    - éƒ¨ç½²æ—¶æœªæ­£ç¡®åœæ­¢æ—§è¿›ç¨‹
    - çƒ­æ›´æ–°å¤±è´¥ï¼Œæ—§è¿›ç¨‹æ®‹ç•™
    - systemd æœåŠ¡åœæ­¢ä¸å½»åº•
    **ä¿®å¤**: ç»ˆæ­¢æ—§è¿›ç¨‹åé‡æ–°å¯åŠ¨

    ### åœºæ™¯ 2: å¤šå®ä¾‹ç«¯å£å†²çªï¼ˆå  15%ï¼‰
    **ç‰¹å¾**: åŒä¸€æœºå™¨éƒ¨ç½²å¤šä¸ªå®ä¾‹ï¼Œç«¯å£ç›¸åŒ
    **æ ¹å› **:
    - æœªä¸ºä¸åŒå®ä¾‹é…ç½®ä¸åŒç«¯å£
    - K8s hostPort å†²çª
    **ä¿®å¤**: ä¸ºä¸åŒå®ä¾‹åˆ†é…ä¸åŒç«¯å£

    ### åœºæ™¯ 3: ä¸åŒæœåŠ¡ç«¯å£å†²çªï¼ˆå  10%ï¼‰
    **ç‰¹å¾**: å ç”¨ç«¯å£çš„æ˜¯å…¶ä»–æœåŠ¡
    **æ ¹å› **:
    - å¤šä¸ªæœåŠ¡é»˜è®¤ä½¿ç”¨ç›¸åŒç«¯å£ï¼ˆå¦‚ 8080ï¼‰
    - æ–°éƒ¨ç½²æœåŠ¡ä¸ç°æœ‰æœåŠ¡ç«¯å£é‡å¤
    **ä¿®å¤**: ä¿®æ”¹å…¶ä¸­ä¸€ä¸ªæœåŠ¡çš„ç«¯å£

    ### åœºæ™¯ 4: åƒµå°¸è¿›ç¨‹å ç”¨ï¼ˆå  5%ï¼‰
    **ç‰¹å¾**: è¿›ç¨‹å·²ä¸å­˜åœ¨ä½†ç«¯å£ä»è¢«å ç”¨
    **æ ¹å› **: 
    - è¿›ç¨‹å¼‚å¸¸é€€å‡ºï¼Œå†…æ ¸æœªåŠæ—¶é‡Šæ”¾ç«¯å£
    - TIME_WAIT çŠ¶æ€
    **ä¿®å¤**: ç­‰å¾…è‡ªåŠ¨é‡Šæ”¾æˆ–é‡å¯ç½‘ç»œæœåŠ¡

    ## è¯Šæ–­æ–¹æ³•è®º

    ### é€šç”¨è¯Šæ–­æµç¨‹
    1. ä»é”™è¯¯æ—¥å¿—æå–ç«¯å£å·
    2. `ss -tlnp | grep <port>` æˆ– `lsof -i:<port>` å®šä½å ç”¨è¿›ç¨‹
    3. åˆ¤æ–­å ç”¨è¿›ç¨‹ç±»å‹ï¼ˆæ—§ç‰ˆæœ¬/å…¶ä»–æœåŠ¡/åƒµå°¸ï¼‰
    4. é’ˆå¯¹æ€§å¤„ç†

    ### å…³é”®è¯Šæ–­å‘½ä»¤
    ```bash
    # æŸ¥çœ‹ç«¯å£å ç”¨
    ss -tlnp | grep <port>
    # æˆ–
    netstat -tlnp | grep <port>
    
    # è·å–è¯¦ç»†è¿›ç¨‹ä¿¡æ¯
    lsof -i:<port>
    
    # æŸ¥çœ‹è¿›ç¨‹è¯¦æƒ…
    ps -fp <PID>
    ```

    ## ğŸ”§ ä¿®å¤å‘½ä»¤ï¼ˆç›´æ¥æ‰§è¡Œï¼‰
    æ ¹æ®é—®é¢˜ç›´æ¥è¿›è¡Œä¿®å¤ï¼Œä¸è¦åªè¾“å‡ºå»ºè®®ï¼

    ### K8s hostPort å†²çªä¿®å¤
    ```bash
    # æ–¹æ¡ˆ1ï¼šåˆ é™¤æœ‰é—®é¢˜çš„ Deploymentï¼ˆå¿«é€Ÿæ­¢æŸï¼‰
    kubectl delete deployment <deployment-name> -n <namespace>
    
    # æ–¹æ¡ˆ2ï¼šç§»é™¤ hostPort é…ç½®ï¼ˆæ¨èï¼‰
    kubectl patch deployment <deployment-name> -n <namespace> --type='json' -p='[{"op":"remove","path":"/spec/template/spec/containers/0/ports/0/hostPort"}]'
    
    # æ–¹æ¡ˆ3ï¼šå…³é—­ hostNetwork
    kubectl patch deployment <deployment-name> -n <namespace> -p '{"spec":{"template":{"spec":{"hostNetwork":false}}}}'
    
    # æ–¹æ¡ˆ4ï¼šä¿®æ”¹ç«¯å£å·ï¼ˆé¿å…å†²çªï¼‰
    kubectl patch deployment <deployment-name> -n <namespace> -p '{"spec":{"template":{"spec":{"containers":[{"name":"<container-name>","ports":[{"containerPort":8082,"hostPort":8082}]}]}}}}'
    
    # æ–¹æ¡ˆ5ï¼šè°ƒåº¦åˆ°ä¸åŒèŠ‚ç‚¹ï¼ˆç§»é™¤ nodeName é™åˆ¶ï¼Œæ·»åŠ åäº²å’Œæ€§ï¼‰
    kubectl patch deployment <deployment-name> -n <namespace> --type='json' -p='[{"op":"remove","path":"/spec/template/spec/nodeName"}]'
    ```

    ### ç‰©ç†æœºç«¯å£å†²çªä¿®å¤
    ```bash
    # ä¼˜é›…ç»ˆæ­¢å ç”¨è¿›ç¨‹
    kill -15 <PID>
    
    # å¦‚ä»å­˜åœ¨ï¼Œå¼ºåˆ¶ç»ˆæ­¢
    kill -9 <PID>
    
    # ä¿®æ”¹åº”ç”¨é…ç½®ä½¿ç”¨å…¶ä»–ç«¯å£ï¼ˆéœ€è¦é‡å¯æœåŠ¡ï¼‰
    ```

    ## ğŸ” ä¿®å¤åéªŒè¯
    ```bash
    # æ£€æŸ¥ Pod æ˜¯å¦æ­£å¸¸è¿è¡Œ
    kubectl get pod -n <namespace>
    
    # æ£€æŸ¥ç«¯å£æ˜¯å¦é‡Šæ”¾
    ss -tlnp | grep <port>
    ```

    ## é¢„é˜²æªæ–½
    - éƒ¨ç½²è„šæœ¬ä¸­å…ˆæ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
    - ä½¿ç”¨è¿›ç¨‹ç®¡ç†å™¨ï¼ˆsystemdï¼‰ç¡®ä¿æœåŠ¡æ­£ç¡®åœæ­¢
    - é…ç½® preStop hook å®ç°ä¼˜é›…å…³é—­
    - ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒç«¯å£æ®µ
    - é¿å…ä½¿ç”¨å¸¸è§é»˜è®¤ç«¯å£ï¼ˆ8080ã€3000 ç­‰ï¼‰

  # ==========================================================================
  # Helm å®‰è£… Observability å¯è§‚æµ‹æ€§å¹³å°
  # ==========================================================================
  helm-observability-install.md: |
    # Helm å®‰è£… Observability å¯è§‚æµ‹æ€§å¹³å°

    ## â›” é‡è¦çº¦æŸï¼ˆå¿…é¡»éµå®ˆï¼‰
    **ç¦æ­¢ä½¿ç”¨ `run_bash_command` æ‰§è¡Œä»»ä½• helm å‘½ä»¤ï¼**
    **å¿…é¡»ä½¿ç”¨ MCP å·¥å…·ï¼ˆhelmcharts å·¥å…·é›†ï¼‰æ‰§è¡Œæ‰€æœ‰ Helm æ“ä½œï¼**

    åŸå› ï¼šHelm CLI ä¸åœ¨ Agent å®¹å™¨å†…ï¼Œæ‰€æœ‰ Helm æ“ä½œå·²å°è£…ä¸º MCP å·¥å…·ã€‚

    ## ğŸ”§ å¯ç”¨çš„ MCP å·¥å…·åˆ—è¡¨

    | MCP å·¥å…·å | åŠŸèƒ½ | æ›¿ä»£çš„ bash å‘½ä»¤ |
    |-----------|------|-----------------|
    | `helm_repo_add` | æ·»åŠ  Helm repo | `helm repo add` |
    | `helm_repo_list` | åˆ—å‡ºå·²æ·»åŠ çš„ repo | `helm repo list` |
    | `helm_repo_update` | æ›´æ–° repo ç´¢å¼• | `helm repo update` |
    | `helm_search_repo` | æœç´¢å¯ç”¨ chart | `helm search repo` |
    | `helm_list_releases` | åˆ—å‡ºå·²å®‰è£…çš„ release | `helm list` |
    | `helm_install` | å®‰è£… chart | `helm install` |
    | `helm_upgrade` | å‡çº§ release | `helm upgrade` |
    | `helm_uninstall` | å¸è½½ release | `helm uninstall` |
    | `helm_status` | æŸ¥çœ‹ release çŠ¶æ€ | `helm status` |
    | `helm_values` | æŸ¥çœ‹ release values | `helm get values` |
    | `helm_history` | æŸ¥çœ‹ release å†å² | `helm history` |
    | `helm_rollback` | å›æ»š release | `helm rollback` |

    ## ğŸ“‹ æ ‡å‡†æ“ä½œæµç¨‹

    ### æ­¥éª¤ 1: æ·»åŠ ç§æœ‰ Repoï¼ˆä½¿ç”¨ MCP å·¥å…·ï¼‰
    è°ƒç”¨å·¥å…·: `helm_repo_add`
    å‚æ•°:
    - name: `observability`
    - url: `http://192.168.1.63/api/v4/projects/65/packages/helm/stable`
    - username: `wanghuhu`
    - password: `glpat-n_ZsxoVt4HxN_ExHENy3`

    ### æ­¥éª¤ 2: æ›´æ–° Repo ç´¢å¼•ï¼ˆä½¿ç”¨ MCP å·¥å…·ï¼‰
    è°ƒç”¨å·¥å…·: `helm_repo_update`

    ### æ­¥éª¤ 3: æœç´¢å¯ç”¨ Chartï¼ˆä½¿ç”¨ MCP å·¥å…·ï¼‰
    è°ƒç”¨å·¥å…·: `helm_search_repo`
    å‚æ•°:
    - keyword: `observability`

    ### æ­¥éª¤ 4: æ£€æŸ¥æ˜¯å¦å·²å®‰è£…ï¼ˆä½¿ç”¨ MCP å·¥å…·ï¼‰
    è°ƒç”¨å·¥å…·: `helm_list_releases`
    å‚æ•°:
    - namespace: `xnet` æˆ– `all`

    ### æ­¥éª¤ 5: å®‰è£… Chartï¼ˆä½¿ç”¨ MCP å·¥å…·ï¼‰
    è°ƒç”¨å·¥å…·: `helm_install`
    å‚æ•°:
    - release_name: `observability`
    - chart: `observability/observability`
    - namespace: `xnet`
    - create_namespace: `true`
    - wait: `true`

    ### æ­¥éª¤ 6: éªŒè¯å®‰è£…çŠ¶æ€ï¼ˆä½¿ç”¨ MCP å·¥å…·ï¼‰
    è°ƒç”¨å·¥å…·: `helm_status`
    å‚æ•°:
    - release_name: `observability`
    - namespace: `xnet`

    ## ğŸ” ç§æœ‰ Repo é…ç½®ä¿¡æ¯

    | é…ç½®é¡¹ | å€¼ |
    |-------|-----|
    | Repo åç§° | `observability` |
    | Repo URL | `http://192.168.1.63/api/v4/projects/65/packages/helm/stable` |
    | ç”¨æˆ·å | `wanghuhu` |
    | å¯†ç /Token | `glpat-n_ZsxoVt4HxN_ExHENy3` |
    | ç›®æ ‡ Namespace | `xnet` |

    ## ğŸ“¦ å¯ç”¨ Charts

    | Chart åç§° | è¯´æ˜ |
    |-----------|------|
    | `observability/observability` | å®Œæ•´å¯è§‚æµ‹æ€§å¹³å°ï¼ˆæ¨èï¼‰ |
    | `observability/prometheus` | Prometheus ç›‘æ§ |
    | `observability/grafana` | Grafana å¯è§†åŒ– |
    | `observability/deepflow` | DeepFlow å¯è§‚æµ‹æ€§ |
    | `observability/elasticsearch` | Elasticsearch æ—¥å¿—å­˜å‚¨ |

    ## ğŸ”„ å‡çº§æ“ä½œæµç¨‹

    ### å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬
    1. è°ƒç”¨ `helm_repo_update` æ›´æ–°ç´¢å¼•
    2. è°ƒç”¨ `helm_upgrade` å‡çº§ release
       - release_name: `observability`
       - chart: `observability/observability`
       - namespace: `xnet`

    ### å›æ»šç‰ˆæœ¬
    1. è°ƒç”¨ `helm_history` æŸ¥çœ‹å†å²ç‰ˆæœ¬
    2. è°ƒç”¨ `helm_rollback` å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬

    ## ğŸ—‘ï¸ å¸è½½æ“ä½œ

    è°ƒç”¨å·¥å…·: `helm_uninstall`
    å‚æ•°:
    - release_name: `observability`
    - namespace: `xnet`

    ## âš ï¸ æ•…éšœæ’æŸ¥

    ### å¦‚æœ MCP å·¥å…·è°ƒç”¨å¤±è´¥
    1. æ£€æŸ¥ MCP æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
    2. æ£€æŸ¥ç½‘ç»œæ˜¯å¦å¯è¾¾ `192.168.1.63`
    3. ç¡®è®¤å‡­è¯æ˜¯å¦æ­£ç¡®

    ### éªŒè¯ç»„ä»¶çŠ¶æ€ï¼ˆå¯ä½¿ç”¨ kubectlï¼‰
    - `kubectl get pods -n xnet`
    - `kubectl get svc -n xnet`

    ## ğŸš« ç¦æ­¢äº‹é¡¹
    - âŒ ç¦æ­¢ä½¿ç”¨ `run_bash_command` æ‰§è¡Œ `helm` å‘½ä»¤
    - âŒ ç¦æ­¢ä½¿ç”¨ `run_bash_command` æ‰§è¡Œ `helm repo add/update/list`
    - âŒ ç¦æ­¢ä½¿ç”¨ `run_bash_command` æ‰§è¡Œ `helm install/upgrade/uninstall`
    - âœ… å¿…é¡»ä½¿ç”¨ä¸Šè¿° MCP å·¥å…·å®Œæˆæ‰€æœ‰ Helm æ“ä½œ

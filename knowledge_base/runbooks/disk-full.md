# 磁盘空间耗尽故障手册

## 故障特征
**错误关键词**: `No space left on device`、`ENOSPC`、`disk full`

**典型表现**:
- 日志无法写入，服务报错
- Docker 镜像拉取失败
- 数据库写入失败
- Pod 启动失败（镜像层无法解压）

## 问题原理
Linux 文件系统空间耗尽时，所有写操作返回 ENOSPC 错误。
常被忽视的是 **inode 耗尽**（大量小文件）也会导致相同错误。

## 常见场景与根因

### 场景 1: 日志膨胀（最常见，占 60%）
**特征**: `/var/log` 目录占用异常
**根因**: 
- 应用日志未配置轮转（logrotate）
- 日志级别设置为 DEBUG 产生大量日志
- 错误循环导致日志爆炸式增长
**修复**: 配置 logrotate，截断大日志文件

### 场景 2: Docker/容器数据堆积（占 25%）
**特征**: `/var/lib/docker` 或 `/var/lib/containerd` 占用异常
**根因**:
- 未清理的旧镜像层
- 已停止容器的数据未清理
- 容器内日志未限制大小
**修复**: `docker system prune -af` 清理未使用资源

### 场景 3: 应用数据增长（占 10%）
**特征**: `/data`、`/home` 或应用自定义目录占用大
**根因**: 业务数据自然增长，未及时归档
**修复**: 归档历史数据，扩容磁盘

### 场景 4: 临时文件未清理（占 5%）
**特征**: `/tmp` 目录占用异常
**根因**: 应用产生临时文件未清理
**修复**: 清理过期临时文件

## 诊断方法论

### 通用诊断流程
1. `df -h` 确认哪个挂载点满了
2. `du -sh /*` 定位一级目录
3. 根据大目录特征匹配上述场景
4. 针对性处理

### 快速定位命令
```bash
# 磁盘使用率
df -h

# 一级目录大小排序
du -sh /* 2>/dev/null | sort -hr | head -5

# Docker 空间使用（如果有）
docker system df
```

## 修复策略

### 安全清理（可直接执行）
- Docker 未使用资源: `docker system prune -af`
- 旧压缩日志: `find /var/log -name "*.gz" -mtime +7 -delete`
- 旧轮转日志: `find /var/log -name "*.log.[0-9]*" -mtime +7 -delete`

### 谨慎清理（需确认后执行）
- 大日志文件: `truncate -s 0 <file>`（截断而非删除，避免句柄问题）
- 应用数据: 确认业务影响后归档或删除

### 不建议清理
- 系统日志（/var/log/messages、syslog）: 保留用于故障排查
- 未知大文件: 先确认用途

## 预防措施
- 配置日志轮转（logrotate）
- 设置磁盘使用率监控告警（阈值 80%）
- 定期执行 Docker 清理任务
- 容器日志配置大小限制
